# MP4 视频拼接工具 - 项目总结

## 项目概述

这是一个基于 Tauri 2.x + Vue 3 + TypeScript 开发的跨平台桌面应用,用于随机选择视频进行拼接。

**仓库地址**: https://github.com/StreadChou/mp4-splicing
**最新版本**: v0.1.3

---

## 技术栈

### 前端
- **框架**: Vue 3 (Composition API)
- **语言**: TypeScript
- **构建工具**: Vite
- **UI**: 原生 CSS (无第三方 UI 库)

### 后端
- **框架**: Tauri 2.x
- **语言**: Rust
- **视频处理**: FFmpeg (通过 sidecar 方式内置)

### 依赖包
**前端**:
- `@tauri-apps/api` - Tauri 核心 API
- `@tauri-apps/plugin-dialog` - 文件/目录选择对话框
- `@tauri-apps/plugin-shell` - Shell 命令执行

**后端**:
- `tauri` - Tauri 核心
- `tauri-plugin-dialog` - 对话框插件
- `tauri-plugin-shell` - Shell 插件
- `serde`, `serde_json` - 序列化/反序列化
- `rand` - 随机数生成
- `walkdir` - 目录遍历
- `chrono` - 时间处理

---

## 核心功能

### 1. 视频选择
- 从指定目录中扫描所有 `.mp4` 文件
- 随机选择指定数量的视频
- 如果请求数量大于可用视频,使用全部并提示用户

### 2. 兼容性检测
- 使用 FFprobe 检测视频的:
  - 编码格式 (codec)
  - 分辨率 (width x height)
  - 帧率 (fps)
- 如果检测到不兼容,弹出对话框让用户选择处理方式

### 3. 视频拼接
**快速模式** (兼容视频):
- 使用 `ffmpeg -c copy` 直接复制流
- 速度快,无质量损失

**重新编码模式** (不兼容视频):
- 使用 `libx264` 编码器重新编码
- 参数: `-preset fast -crf 23`
- 音频: AAC 192k

### 4. 结尾视频
- 可选功能
- 在随机视频后添加固定的结尾视频

### 5. 进度反馈
- 实时显示处理进度
- 通过 Tauri 事件系统发送进度消息

---

## 项目结构

```
mp4handler/
├── .github/
│   └── workflows/
│       └── build.yml              # GitHub Actions 自动打包配置
├── src/                           # 前端源码
│   ├── App.vue                    # 主界面组件
│   └── ...
├── src-tauri/                     # 后端源码
│   ├── src/
│   │   ├── lib.rs                 # 入口文件,注册命令和插件
│   │   └── video_processor.rs    # 视频处理核心逻辑
│   ├── binaries/                  # FFmpeg 二进制文件
│   │   ├── ffmpeg-aarch64-apple-darwin
│   │   ├── ffprobe-aarch64-apple-darwin
│   │   ├── ffmpeg-x86_64-pc-windows-msvc.exe
│   │   └── ffprobe-x86_64-pc-windows-msvc.exe
│   ├── capabilities/
│   │   └── default.json           # 权限配置
│   ├── Cargo.toml                 # Rust 依赖配置
│   └── tauri.conf.json            # Tauri 配置
├── package.json                   # 前端依赖配置
└── vite.config.ts                 # Vite 配置
```

---

## 关键文件说明

### 1. `src/App.vue`
前端主界面,包含:
- 输入目录选择
- 结尾视频选择
- 随机数量输入
- 输出目录选择
- 开始拼接按钮
- 进度显示
- 错误提示
- 兼容性确认对话框

**关键函数**:
- `selectInputDir()` - 选择输入目录
- `selectEndingVideo()` - 选择结尾视频
- `selectOutputDir()` - 选择输出目录
- `startConcat()` - 开始拼接(快速模式)
- `concatWithReencode()` - 重新编码拼接

### 2. `src-tauri/src/video_processor.rs`
视频处理核心逻辑:

**主要函数**:
```rust
// 随机选择视频
fn get_random_videos(dir: &str, count: usize) -> Result<(Vec<PathBuf>, usize), String>

// 获取视频信息
async fn get_video_info(app: &AppHandle, video_path: &Path) -> Result<VideoInfo, String>

// 检测兼容性
async fn check_video_compatibility(app: &AppHandle, videos: &[PathBuf]) -> Result<CompatibilityResult, String>

// 创建 concat 文件
fn create_concat_file(videos: &[PathBuf], temp_dir: &Path) -> Result<PathBuf, String>

// 快速拼接命令
#[tauri::command]
pub async fn concat_videos(app: AppHandle, input_dir: String, ending_video: Option<String>, random_count: usize, output_dir: String) -> Result<String, String>

// 重新编码拼接命令
#[tauri::command]
pub async fn concat_videos_with_reencode(app: AppHandle, input_dir: String, ending_video: Option<String>, random_count: usize, output_dir: String) -> Result<String, String>
```

### 3. `src-tauri/src/lib.rs`
Tauri 应用入口:
```rust
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_opener::init())
        .plugin(tauri_plugin_dialog::init())
        .plugin(tauri_plugin_shell::init())
        .invoke_handler(tauri::generate_handler![
            greet,
            video_processor::concat_videos,
            video_processor::concat_videos_with_reencode
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### 4. `src-tauri/capabilities/default.json`
权限配置:
```json
{
  "permissions": [
    "core:default",
    "opener:default",
    "dialog:default",
    "shell:default",
    "shell:allow-execute",
    "shell:allow-spawn"
  ]
}
```

### 5. `.github/workflows/build.yml`
GitHub Actions 自动打包配置:
- 在 macOS 和 Windows 环境中自动构建
- 生成便携版和安装版
- 上传为 Artifacts

---

## 开发命令

### 安装依赖
```bash
yarn install
```

### 开发模式
```bash
yarn tauri dev
```

### 打包
```bash
yarn tauri build
```

### 发布新版本
```bash
git tag v0.1.x
git push origin v0.1.x
# 等待 GitHub Actions 构建完成
gh run download <run-id>
gh release create v0.1.x --title "版本标题" --notes "更新说明" macos-build/*.zip windows-build/*.zip windows-build/bundle/nsis/*.exe
```

---

## 输出文件

### macOS
- **开发**: `src-tauri/target/debug/mp4handler`
- **发布**: `src-tauri/target/release/bundle/macos/mp4handler.app`
- **便携版**: `mp4handler-macos-portable.zip`

### Windows
- **开发**: `src-tauri/target/debug/mp4handler.exe`
- **发布**: `src-tauri/target/release/mp4handler.exe`
- **安装程序**: `src-tauri/target/release/bundle/nsis/mp4handler_0.1.0_x64-setup.exe`
- **便携版**: `mp4handler-windows-portable.zip`

---

## 工作流程

### 用户操作流程
1. 选择包含 MP4 文件的输入目录
2. (可选) 选择结尾视频
3. 设置随机选择的视频数量
4. 选择输出目录
5. 点击"开始拼接"
6. 如果视频不兼容,选择处理方式:
   - 直接拼接(快速但可能失败)
   - 重新编码拼接(慢但保证成功)
7. 等待处理完成
8. 在输出目录查看生成的视频

### 技术流程
1. **前端**: 用户点击"开始拼接"
2. **前端**: 调用 `invoke('concat_videos', {...})`
3. **后端**: 接收参数,验证输入
4. **后端**: 扫描目录,随机选择视频
5. **后端**: 使用 FFprobe 检测视频兼容性
6. **后端**: 如果不兼容,返回错误码 `INCOMPATIBLE_VIDEOS:`
7. **前端**: 显示兼容性对话框
8. **前端**: 根据用户选择调用对应命令
9. **后端**: 创建临时 concat 文件
10. **后端**: 调用 FFmpeg 拼接视频
11. **后端**: 发送进度事件到前端
12. **后端**: 清理临时文件
13. **后端**: 返回成功消息
14. **前端**: 显示完成提示

---

## 进度事件

后端通过 `window.emit("progress", message)` 发送进度:
- "正在扫描视频文件..."
- "已选择 X 个视频"
- "请求 X 个视频,但只找到 Y 个,将使用全部 Y 个视频"
- "已添加结尾视频"
- "正在检测视频兼容性..."
- "正在拼接视频(快速模式)..."
- "正在拼接视频(重新编码模式,这可能需要较长时间)..."
- "完成!"

前端通过 `listen("progress", callback)` 监听并显示。

---

## 错误处理

### 前端验证
- 输入目录不能为空
- 输出目录不能为空
- 随机数量必须 > 0

### 后端错误
- 目录不存在或无权限
- 未找到 MP4 文件
- 结尾视频不存在
- FFmpeg/FFprobe 执行失败
- 视频不兼容 (特殊错误码: `INCOMPATIBLE_VIDEOS:`)

所有错误都返回中文描述。

---

## FFmpeg 使用

### 快速拼接 (兼容视频)
```bash
ffmpeg -f concat -safe 0 -i concat_list.txt -c copy output.mp4
```

### 重新编码拼接 (不兼容视频)
```bash
ffmpeg -f concat -safe 0 -i concat_list.txt \
  -c:v libx264 -preset fast -crf 23 \
  -c:a aac -b:a 192k \
  output.mp4
```

### 检测视频信息
```bash
ffprobe -v error -select_streams v:0 \
  -show_entries stream=codec_name,width,height,r_frame_rate \
  -of json video.mp4
```

---

## 已知问题和限制

### 1. Wine 兼容性
- Windows 便携版在 Wine 中运行存在图形渲染问题
- WebView2 在 Wine 中支持不完整
- 建议在真实 Windows 环境中运行

### 2. 视频格式
- 仅支持 `.mp4` 格式
- 其他格式需要先转换

### 3. 文件大小
- 应用体积较大 (约 160-200 MB)
- 因为内置了完整的 FFmpeg

### 4. 性能
- 重新编码模式较慢,取决于视频大小和数量
- 快速模式几乎瞬间完成

---

## 后续开发建议

### 功能增强
1. **视频预览**: 显示选中视频的缩略图
2. **进度条**: 显示百分比进度(需要解析 FFmpeg 输出)
3. **取消功能**: 允许中途取消处理
4. **批量处理**: 支持生成多个拼接视频
5. **自定义顺序**: 允许手动排序视频
6. **保存配置**: 记住上次使用的目录和设置
7. **更多格式**: 支持 `.avi`, `.mov`, `.mkv` 等格式
8. **转场效果**: 添加视频之间的转场动画
9. **音频处理**: 支持添加背景音乐、调整音量
10. **字幕支持**: 支持添加字幕文件

### 技术优化
1. **错误恢复**: 单个视频失败时继续处理其他视频
2. **日志系统**: 记录详细的操作日志
3. **多语言**: 支持英文等其他语言
4. **主题切换**: 支持亮色/暗色主题
5. **性能优化**: 使用多线程处理
6. **内存优化**: 处理大文件时的内存管理

### 用户体验
1. **拖拽支持**: 支持拖拽文件/文件夹
2. **快捷键**: 添加键盘快捷键
3. **历史记录**: 记录最近的操作
4. **预设模板**: 提供常用配置模板
5. **帮助文档**: 内置使用说明

---

## 调试技巧

### 查看 Rust 日志
```bash
RUST_LOG=debug yarn tauri dev
```

### 查看前端控制台
在开发模式下,按 `Cmd+Option+I` (macOS) 或 `F12` (Windows) 打开开发者工具。

### 测试 FFmpeg
```bash
# macOS
./src-tauri/binaries/ffmpeg-aarch64-apple-darwin -version

# Windows
./src-tauri/binaries/ffmpeg-x86_64-pc-windows-msvc.exe -version
```

### 清理构建缓存
```bash
cd src-tauri
cargo clean
cd ..
rm -rf node_modules dist
yarn install
```

---

## 相关资源

- **Tauri 文档**: https://tauri.app/
- **Vue 3 文档**: https://vuejs.org/
- **FFmpeg 文档**: https://ffmpeg.org/documentation.html
- **Rust 文档**: https://doc.rust-lang.org/

---

## 许可证

请确保遵守 FFmpeg 的 LGPL/GPL 许可证要求。

---

**最后更新**: 2026-01-28
**版本**: v0.1.4

## 更新日志

### v0.1.4 (2026-01-28)
- 新增交互式视频拆解功能
- 新增批量视频拆解功能
- 优化 UI 布局，采用左侧导航栏设计
- 重构代码为组件化架构
- 优化颜色对比度，提升可读性
- 添加帧选择后自动滚动到顶部功能
- 增强选中帧的视觉反馈（4px 边框）
