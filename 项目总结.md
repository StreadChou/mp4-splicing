# MP4 视频拼接工具 - 项目总结

## 项目概述

这是一个基于 Tauri 2.x + Vue 3 + TypeScript 开发的跨平台桌面应用,用于随机选择视频进行拼接。

**仓库地址**: https://github.com/StreadChou/mp4-splicing
**最新版本**: v0.1.13

---

## 技术栈

### 前端
- **框架**: Vue 3 (Composition API)
- **语言**: TypeScript
- **构建工具**: Vite
- **UI 框架**: Quasar Framework

### 后端
- **框架**: Tauri 2.x
- **语言**: Rust
- **视频处理**: FFmpeg (通过 sidecar 方式内置)

### 依赖包
**前端**:
- `@tauri-apps/api` - Tauri 核心 API
- `@tauri-apps/plugin-dialog` - 文件/目录选择对话框
- `@tauri-apps/plugin-shell` - Shell 命令执行
- `quasar` - Quasar UI 框架
- `@quasar/extras` - Quasar 图标和字体
- `vue` - Vue 3 框架

**后端**:
- `tauri` - Tauri 核心
- `tauri-plugin-dialog` - 对话框插件
- `tauri-plugin-shell` - Shell 插件
- `serde`, `serde_json` - 序列化/反序列化
- `rand` - 随机数生成
- `walkdir` - 目录遍历
- `chrono` - 时间处理
- `image` - 图像处理
- `imageproc` - 图像处理算法
- `rayon` - 数据并行计算库
- `reqwest` - HTTP 客户端（v0.1.11 新增）
- `tokio` - 异步运行时（v0.1.11 新增）
- `futures-util` - 异步工具库（v0.1.11 新增）

---

## 核心功能

### 1. 视频拼接
- 从指定目录中扫描所有 `.mp4` 文件
- **不放回随机抽取**：实现视频池管理机制，避免重复选择同一视频
- 池子为空时自动重新填充，支持多目录独立管理
- 显示池子剩余数量和重填状态
- 如果请求数量大于可用视频,使用全部并提示用户
- 支持添加固定的结尾视频
- 自动检测视频兼容性
- 支持快速模式和重新编码模式
- **音画同步优化**：使用 filter_complex 统一重编码，彻底解决音画不同步问题

### 2. 视频拆解（单个）
- 提取视频所有帧的缩略图
- 可视化帧选择界面（12列网格布局）
- 点击选择起始和结束帧
- 支持多个片段选择
- 精确按帧切割视频
- 自动重新编码确保质量

### 3. 批量拆解
- 批量处理文件夹中的所有视频
- 支持断点续传（保存进度到 JSON 文件）
- 预加载机制（提前加载后续 2 个任务）
- 灵活操作：跳过、稍后处理、删除原文件
- 实时进度反馈

### 4. 自动拆解（新功能 v0.1.8）
- **智能场景检测**：基于帧相似度自动切分视频
- **三种算法**：
  - 直方图（快速）：使用巴氏距离计算灰度直方图相似度
  - SSIM（准确）：结构相似性算法，考虑亮度、对比度和结构
  - 帧差异（简单）：简单的像素差异计算
- **可配置参数**：
  - 相似度阈值（0-100%）：低于此阈值时切分场景
  - 最小片段秒数：片段长度必须大于此值
  - **掐头选项**（v0.1.13）：跳过第一个识别的片段
  - **去尾选项**（v0.1.13）：跳过最后一个识别的片段（默认启用）
- **无人值守模式**：启用后自动保留原视频并处理下一个
- **批量处理**：自动处理文件夹中的所有视频
- **断点续传**：支持暂停和恢复
- **多线程优化**（v0.1.9）：使用 rayon 并行计算帧相似度，性能提升 5-8 倍
- **音画同步**（v0.1.12）：使用精确时间戳和 PTS 重置，确保拆解后音画同步

### 5. 批量下载（新功能 v0.1.11）
- **多 URL 下载**：支持从多个 URL 并发下载视频文件
- **并发控制**：可配置最大并发数（默认 3 个）
- **实时进度**：显示每个任务的下载进度和速度
- **智能解析**：自动从 URL 提取文件名，过滤空行
- **流式下载**：使用流式传输，避免内存占用过大
- **错误处理**：单个下载失败不影响其他任务

### 6. 兼容性检测
- 使用 FFprobe 检测视频的:
  - 编码格式 (codec)
  - 分辨率 (width x height)
  - 帧率 (fps)
- 如果检测到不兼容,弹出对话框让用户选择处理方式

### 7. 视频拼接模式
**快速模式** (兼容视频):
- 使用 `ffmpeg -c copy` 直接复制流
- 速度快,无质量损失

**重新编码模式** (不兼容视频 - v0.1.12 优化):
- 使用 `filter_complex` 统一处理所有视频流
- 每个视频流独立处理：scale + pad + setpts=PTS-STARTPTS
- 每个音频流独立处理：aresample + asetpts=PTS-STARTPTS
- 无音频视频自动补齐静音音轨
- 使用 concat 滤镜拼接，确保时间戳从零开始连续
- 彻底解决音画不同步问题

### 8. 进度反馈
- 实时显示处理进度
- 通过 Tauri 事件系统发送进度消息
- 支持帧提取进度、片段生成进度、相似度分析进度

---

## 项目结构

```
mp4handler/
├── .github/
│   └── workflows/
│       └── build.yml              # GitHub Actions 自动打包配置
├── src/                           # 前端源码
│   ├── App.vue                    # 主界面组件（Tab 导航）
│   └── components/
│       ├── VideoConcat.vue        # 视频拼接组件
│       ├── SingleSplit.vue        # 单个视频拆解组件
│       ├── BatchSplit.vue         # 批量拆解组件
│       ├── AutoSplit.vue          # 自动拆解组件（新增 v0.1.8）
│       ├── BatchDownload.vue      # 批量下载组件（新增 v0.1.11）
│       └── VideoSplitter.vue      # 帧选择器组件（共用）
├── src-tauri/                     # 后端源码
│   ├── src/
│   │   ├── lib.rs                 # 入口文件,注册命令和插件
│   │   ├── video_processor.rs    # 视频拼接核心逻辑
│   │   ├── video_frame_extractor.rs  # 视频帧提取和拆解逻辑
│   │   ├── frame_similarity.rs   # 帧相似度算法（新增 v0.1.8）
│   │   └── downloader.rs          # 批量下载模块（新增 v0.1.11）
│   ├── binaries/                  # FFmpeg 二进制文件
│   │   ├── ffmpeg-aarch64-apple-darwin
│   │   ├── ffprobe-aarch64-apple-darwin
│   │   ├── ffmpeg-x86_64-pc-windows-msvc.exe
│   │   └── ffprobe-x86_64-pc-windows-msvc.exe
│   ├── capabilities/
│   │   └── default.json           # 权限配置
│   ├── Cargo.toml                 # Rust 依赖配置
│   └── tauri.conf.json            # Tauri 配置
├── package.json                   # 前端依赖配置
└── vite.config.ts                 # Vite 配置
```

---

## 关键文件说明

### 1. `src/App.vue`
前端主界面，采用左侧 Tab 导航设计，包含五个功能模块：
- 视频拼接
- 视频拆解（单个）
- 批量拆解
- 自动拆解（新增 v0.1.8）
- 批量下载（新增 v0.1.11）

### 2. `src/components/BatchDownload.vue` (新增 v0.1.11)
批量下载界面组件，包含：
- URL 列表输入框（textarea，支持多行）
- 输出目录选择
- 下载任务列表显示
- 实时进度和速度显示

**关键函数**：
- `startDownload()` - 开始批量下载
- `selectOutputDir()` - 选择输出目录
- `extractFilename()` - 从 URL 提取文件名
- `getStatusIcon()` / `getStatusColor()` - 获取任务状态图标和颜色

### 3. `src/components/AutoSplit.vue` (新增 v0.1.8)
自动拆解界面组件，包含：
- 输入/输出文件夹选择
- 算法选择（直方图、SSIM、帧差异）
- 相似度阈值滑块（0-100%）
- 最小片段秒数输入
- 无人值守模式复选框
- 批量任务进度显示
- 跳过、稍后处理等操作按钮

**关键函数**：
- `startAutoSplit()` - 开始自动拆解
- `processCurrentTask()` - 处理当前任务
- `skipCurrentVideo()` - 跳过当前视频
- `postponeCurrentVideo()` - 稍后处理
- `deleteAndNext()` - 删除原视频并继续
- `nextWithoutDelete()` - 保留原视频并继续

### 4. `src-tauri/src/downloader.rs` (新增 v0.1.11)
批量下载模块：

**主要函数**：
```rust
// 批量下载命令
#[tauri::command]
pub async fn batch_download(
    app: AppHandle,
    urls: Vec<String>,
    output_dir: String,
    max_concurrent: usize,
) -> Result<String, String>

// 下载单个文件
async fn download_single_file(
    client: &Client,
    url: &str,
    output_dir: &str,
    window: tauri::WebviewWindow,
) -> Result<(), String>

// 从 URL 提取文件名
fn extract_filename(url: &str) -> String
```

### 5. `src-tauri/src/frame_similarity.rs` (新增 v0.1.8)
帧相似度算法模块：

**主要函数**：
```rust
// 计算两张图片的相似度
pub fn calculate_similarity(
    img1_path: &str,
    img2_path: &str,
    algorithm: SimilarityAlgorithm,
) -> Result<f64, String>

// 直方图相似度算法
fn histogram_similarity(img1: &DynamicImage, img2: &DynamicImage) -> Result<f64, String>

// SSIM 算法
fn ssim_similarity(img1: &DynamicImage, img2: &DynamicImage) -> Result<f64, String>

// 帧差异算法
fn frame_diff_similarity(img1: &DynamicImage, img2: &DynamicImage) -> Result<f64, String>
```

### 6. `src-tauri/src/video_frame_extractor.rs`
视频帧提取和拆解核心逻辑：

**主要函数**：
```rust
// 获取视频元数据
#[tauri::command]
pub async fn get_video_metadata(app: AppHandle, video_path: String) -> Result<VideoMetadata, String>

// 提取所有帧
#[tauri::command]
pub async fn extract_all_frames(app: AppHandle, video_path: String) -> Result<Vec<FrameInfo>, String>

// 生成视频片段
#[tauri::command]
pub async fn generate_video_segments(app: AppHandle, video_path: String, segments: Vec<SegmentRange>, output_dir: String) -> Result<String, String>

// 自动拆解视频（新增 v0.1.8）
#[tauri::command]
pub async fn auto_split_video(
    app: AppHandle,
    video_path: String,
    output_dir: String,
    algorithm: String,
    threshold: f64,
    min_duration: f64,
) -> Result<String, String>

// 列出 MP4 文件
#[tauri::command]
pub fn list_mp4_files(dir_path: String) -> Result<Vec<String>, String>

// 批量进度管理
#[tauri::command]
pub fn load_batch_progress(progress_path: String) -> Result<Option<BatchProgress>, String>

#[tauri::command]
pub fn save_batch_progress(progress_path: String, progress: BatchProgress) -> Result<(), String>
```

### 6. `src-tauri/src/video_processor.rs`
视频拼接核心逻辑：

**主要结构**：
```rust
// 视频池状态（v0.1.13 新增）
pub struct VideoPoolState {
    pub all_videos: Vec<PathBuf>,      // 完整视频列表
    pub remaining_videos: Vec<PathBuf>, // 剩余可用视频
}

// 全局视频池管理器（v0.1.13 新增）
pub struct VideoPoolManager {
    pools: Mutex<HashMap<String, VideoPoolState>>,
}
```

**主要函数**：
```rust
// 随机选择视频（已废弃，改用视频池）
fn get_random_videos(dir: &str, count: usize) -> Result<(Vec<PathBuf>, usize), String>

// 视频池管理（v0.1.13 新增）
impl VideoPoolManager {
    pub fn get_or_create_pool(...) -> VideoPoolState
    pub fn draw_videos(...) -> Result<Vec<PathBuf>, String>
    pub fn get_remaining_count(...) -> usize
}

// 获取视频信息
async fn get_video_info(app: &AppHandle, video_path: &Path) -> Result<VideoInfo, String>

// 检测兼容性
async fn check_video_compatibility(app: &AppHandle, videos: &[PathBuf]) -> Result<CompatibilityResult, String>

// 快速拼接命令
#[tauri::command]
pub async fn concat_videos(app: AppHandle, input_dir: String, ending_video: Option<String>, random_count: usize, output_dir: String) -> Result<String, String>

// 重新编码拼接命令（v0.1.12 优化）
#[tauri::command]
pub async fn concat_videos_with_reencode(app: AppHandle, input_dir: String, ending_video: Option<String>, random_count: usize, output_dir: String) -> Result<String, String>
```

### 8. `src-tauri/src/lib.rs`
Tauri 应用入口：
```rust
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_opener::init())
        .plugin(tauri_plugin_dialog::init())
        .plugin(tauri_plugin_shell::init())
        .manage(video_processor::VideoPoolManager::new())  // v0.1.13 新增
        .invoke_handler(tauri::generate_handler![
            greet,
            video_processor::concat_videos,
            video_processor::concat_videos_with_reencode,
            video_frame_extractor::get_video_metadata,
            video_frame_extractor::extract_all_frames,
            video_frame_extractor::generate_video_segments,
            video_frame_extractor::list_mp4_files,
            video_frame_extractor::load_batch_progress,
            video_frame_extractor::save_batch_progress,
            video_frame_extractor::delete_video_file,
            video_frame_extractor::auto_split_video,  // 新增 v0.1.8
            downloader::batch_download,  // 新增 v0.1.11
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```
权限配置:
```json
{
  "permissions": [
    "core:default",
    "opener:default",
    "dialog:default",
    "shell:default",
    "shell:allow-execute",
    "shell:allow-spawn"
  ]
}
```

### 9. `.github/workflows/build.yml`
GitHub Actions 自动打包配置:
- 在 macOS 和 Windows 环境中自动构建
- 生成便携版和安装版
- 上传为 Artifacts

---

## 开发命令

### 安装依赖
```bash
yarn install
```

### 开发模式
```bash
yarn tauri dev
```

### 打包
```bash
yarn tauri build
```

### 发布新版本
```bash
git tag v0.1.x
git push origin v0.1.x
# 等待 GitHub Actions 构建完成
gh run download <run-id>
gh release create v0.1.x --title "版本标题" --notes "更新说明" macos-build/*.zip windows-build/*.zip windows-build/bundle/nsis/*.exe
```

---

## 输出文件

### macOS
- **开发**: `src-tauri/target/debug/mp4handler`
- **发布**: `src-tauri/target/release/bundle/macos/mp4handler.app`
- **便携版**: `mp4handler-macos-portable.zip`

### Windows
- **开发**: `src-tauri/target/debug/mp4handler.exe`
- **发布**: `src-tauri/target/release/mp4handler.exe`
- **安装程序**: `src-tauri/target/release/bundle/nsis/mp4handler_0.1.8_x64-setup.exe`
- ~~**便携版**: 已移除（v0.1.8）~~

---

## 工作流程

### 视频拼接流程
1. 选择包含 MP4 文件的输入目录
2. (可选) 选择结尾视频
3. 设置随机选择的视频数量
4. 选择输出目录
5. 点击"开始拼接"
6. **视频池机制**（v0.1.13）：
   - 系统维护视频池，实现不放回抽取
   - 显示池子剩余数量
   - 池子为空时自动重新填充并提示
7. 如果视频不兼容,选择处理方式:
   - 直接拼接(快速但可能失败)
   - 重新编码拼接(慢但保证成功，音画同步)
8. 等待处理完成
9. 在输出目录查看生成的视频

### 单个视频拆解流程
1. 选择要拆解的视频文件
2. 等待提取所有帧的缩略图
3. 在网格中点击选择起始帧和结束帧
4. 可以选择多个片段
5. 点击"开始生成"
6. 等待片段生成完成

### 批量拆解流程
1. 选择包含视频的输入文件夹
2. 选择输出文件夹
3. 点击"开始读取"
4. 系统加载第一个视频的帧
5. 手动选择要拆解的片段
6. 点击"开始生成"
7. 选择删除或保留原视频
8. 自动加载下一个视频
9. 重复步骤 5-8 直到所有视频处理完成

### 自动拆解流程（新增 v0.1.8）
1. 选择包含视频的输入文件夹
2. 选择输出文件夹
3. 配置参数：
   - 选择相似度算法（直方图/SSIM/帧差异）
   - 设置相似度阈值（默认 70%）
   - 设置最小片段秒数（默认 2 秒）
   - **掐头选项**（v0.1.13）：跳过第一个片段
   - **去尾选项**（v0.1.13）：跳过最后一个片段（默认启用）
   - (可选) 启用无人值守模式
4. 点击"开始自动拆解"
5. 系统自动处理每个视频：
   - 提取所有帧
   - 逐帧对比相似度
   - 检测场景切换点
   - 根据掐头去尾设置过滤片段
   - 自动生成片段
6. 如果启用无人值守模式：
   - 自动保留原视频并处理下一个
7. 如果未启用无人值守模式：
   - 选择删除或保留原视频
   - 手动点击继续下一个
8. 所有视频处理完成后显示提示

### 批量下载流程（新增 v0.1.11）
1. 在 textarea 中输入多个视频 URL（每行一个）
2. 选择输出目录
3. 点击"开始下载"
4. 系统自动：
   - 解析 URL 列表（过滤空行）
   - 创建下载任务
   - 并发下载（最多 3 个同时进行）
   - 实时显示进度和速度
5. 下载完成后显示成功/失败统计
6. 在输出目录查看下载的文件

### 技术流程
1. **前端**: 用户点击"开始拼接"
2. **前端**: 调用 `invoke('concat_videos', {...})`
3. **后端**: 接收参数,验证输入
4. **后端**: 扫描目录,随机选择视频
5. **后端**: 使用 FFprobe 检测视频兼容性
6. **后端**: 如果不兼容,返回错误码 `INCOMPATIBLE_VIDEOS:`
7. **前端**: 显示兼容性对话框
8. **前端**: 根据用户选择调用对应命令
9. **后端**: 创建临时 concat 文件
10. **后端**: 调用 FFmpeg 拼接视频
11. **后端**: 发送进度事件到前端
12. **后端**: 清理临时文件
13. **后端**: 返回成功消息
14. **前端**: 显示完成提示

---

## 进度事件

后端通过 Tauri 事件系统发送进度更新：

### 视频拼接进度
- "正在扫描视频文件..."
- "已选择 X 个视频"
- "请求 X 个视频,但只找到 Y 个,将使用全部 Y 个视频"
- "已添加结尾视频"
- **"视频池剩余: X 个"**（v0.1.13）
- **"视频池已空，重新填充 X 个视频"**（v0.1.13）
- "正在检测视频兼容性..."
- "正在拼接视频(快速模式)..."
- "正在拼接视频(重新编码模式,这可能需要较长时间)..."
- "完成!"

### 帧提取进度 (`frame_progress`)
- `{ message: "正在提取视频帧...", percent: 0 }`
- `{ message: "已提取 X/Y 帧", percent: 50 }`

### 片段生成进度 (`segment_progress`)
- `{ current: 1, total: 5, segmentName: "video_1.mp4", percent: 20 }`

### 自动拆解进度 (`auto_split_progress`)（新增 v0.1.8）
- `{ message: "正在提取视频帧...", percent: 0 }`
- `{ message: "正在分析帧相似度...", percent: 10 }`
- `{ message: "已分析 X/Y 帧", percent: 50 }`
- **`{ message: "检测到 X 个片段，过滤后剩余 Y 个", percent: 65 }`**（v0.1.13）
- `{ message: "正在生成视频片段...", percent: 70 }`
- `{ message: "完成", percent: 100 }`

### 下载进度 (`download_progress`)（新增 v0.1.11）
- `{ url: "...", progress: 0, speed: "0 MB/s", status: "downloading" }`
- `{ url: "...", progress: 50, speed: "5.23 MB/s", status: "downloading" }`
- `{ url: "...", progress: 100, speed: "0 MB/s", status: "completed" }`
- `{ url: "...", progress: 0, speed: "0 MB/s", status: "failed" }`

前端通过 `listen("event_name", callback)` 监听并显示。

---

## 错误处理

### 前端验证
- 输入目录不能为空
- 输出目录不能为空
- 随机数量必须 > 0

### 后端错误
- 目录不存在或无权限
- 未找到 MP4 文件
- 结尾视频不存在
- FFmpeg/FFprobe 执行失败
- 视频不兼容 (特殊错误码: `INCOMPATIBLE_VIDEOS:`)

所有错误都返回中文描述。

---

## FFmpeg 使用

### 快速拼接 (兼容视频)
```bash
ffmpeg -f concat -safe 0 -i concat_list.txt -c copy output.mp4
```

### 重新编码拼接 (不兼容视频 - v0.1.12 优化)
使用 filter_complex 统一处理：
```bash
ffmpeg -i video1.mp4 -i video2.mp4 \
  -filter_complex "\
    [0:v]scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2,setpts=PTS-STARTPTS[v0]; \
    [0:a]aresample=48000,asetpts=PTS-STARTPTS[a0]; \
    [1:v]scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2,setpts=PTS-STARTPTS[v1]; \
    [1:a]aresample=48000,asetpts=PTS-STARTPTS[a1]; \
    [v0][a0][v1][a1]concat=n=2:v=1:a=1[outv][outa]" \
  -map "[outv]" -map "[outa]" \
  -c:v libx264 -preset fast -crf 23 \
  -c:a aac -b:a 192k \
  output.mp4
```
- 每个视频流独立处理并重置时间戳
- 无音频视频自动补齐静音音轨
- 彻底解决音画不同步问题

### 检测视频信息
```bash
ffprobe -v error -select_streams v:0 \
  -show_entries stream=codec_name,width,height,r_frame_rate \
  -of json video.mp4
```

### 提取所有帧
```bash
ffmpeg -i video.mp4 \
  -vf "fps=30,scale=320:-1" \
  -vsync 0 -q:v 3 \
  frame_%05d.jpg
```

### 精确切割视频片段（v0.1.12 优化）
```bash
# 使用精确时间戳和 PTS 重置
ffmpeg -i video.mp4 \
  -ss 10.5 -t 5.0 \
  -vf "setpts=PTS-STARTPTS" \
  -af "asetpts=PTS-STARTPTS" \
  -c:v libx264 -preset fast -crf 18 \
  -r 30 -c:a aac -b:a 192k \
  output.mp4
```
- 使用 ffprobe 获取精确帧时间戳
- 时间戳归一化处理，确保从零开始
- 视频和音频时间戳同步重置

---

## 已知问题和限制

### 1. 视频格式
- 仅支持 `.mp4` 格式
- 其他格式需要先转换

### 2. 文件大小
- 应用体积较大 (约 160-200 MB)
- 因为内置了完整的 FFmpeg

### 3. 性能
- 重新编码模式较慢,取决于视频大小和数量
- 快速模式几乎瞬间完成
- 自动拆解已优化为多线程并行计算（v0.1.9）：
  - 10 分钟 30fps 视频（18,000 帧）处理时间：
    - 直方图算法：约 10-15 秒
    - 帧差异算法：约 15-25 秒
    - SSIM 算法：约 30-45 秒
  - 多核 CPU 利用率可达 80-90%

### 4. 打包
- Windows 便携版已移除（v0.1.8）
- 仅提供 Windows 安装包和 macOS 便携版

---

## 后续开发建议

### 功能增强
1. ~~**视频预览**: 显示选中视频的缩略图~~ ✅ 已实现（v0.1.4）
2. **进度条**: 显示百分比进度 ✅ 已实现（v0.1.4）
3. **取消功能**: 允许中途取消处理
4. ~~**批量处理**: 支持生成多个拼接视频~~ ✅ 已实现（v0.1.4）
5. ~~**不放回随机抽取**: 避免重复选择同一视频~~ ✅ 已实现（v0.1.13）
6. **自定义顺序**: 允许手动排序视频
7. **保存配置**: 记住上次使用的目录和设置
8. **更多格式**: 支持 `.avi`, `.mov`, `.mkv` 等格式
9. **转场效果**: 添加视频之间的转场动画
10. **音频处理**: 支持添加背景音乐、调整音量
11. **字幕支持**: 支持添加字幕文件
12. ~~**智能场景检测**: 自动识别场景切换点~~ ✅ 已实现（v0.1.8）
13. ~~**掐头去尾功能**: 跳过首尾片段~~ ✅ 已实现（v0.1.13）
14. ~~**音画同步优化**: 彻底解决音画不同步问题~~ ✅ 已实现（v0.1.12）
15. **更多相似度算法**: PSNR、边缘检测等
16. **GPU 加速**: 使用 GPU 加速图像处理

### 技术优化
1. **错误恢复**: 单个视频失败时继续处理其他视频
2. **日志系统**: 记录详细的操作日志
3. **多语言**: 支持英文等其他语言
4. **主题切换**: 支持亮色/暗色主题
5. ~~**性能优化**: 使用多线程处理~~ ✅ 已实现（v0.1.9）
6. **内存优化**: 处理大文件时的内存管理

### 用户体验
1. **拖拽支持**: 支持拖拽文件/文件夹
2. **快捷键**: 添加键盘快捷键
3. **历史记录**: 记录最近的操作
4. **预设模板**: 提供常用配置模板
5. **帮助文档**: 内置使用说明

---

## 调试技巧

### 查看 Rust 日志
```bash
RUST_LOG=debug yarn tauri dev
```

### 查看前端控制台
在开发模式下,按 `Cmd+Option+I` (macOS) 或 `F12` (Windows) 打开开发者工具。

### 测试 FFmpeg
```bash
# macOS
./src-tauri/binaries/ffmpeg-aarch64-apple-darwin -version

# Windows
./src-tauri/binaries/ffmpeg-x86_64-pc-windows-msvc.exe -version
```

### 清理构建缓存
```bash
cd src-tauri
cargo clean
cd ..
rm -rf node_modules dist
yarn install
```

---

## 相关资源

- **Tauri 文档**: https://tauri.app/
- **Vue 3 文档**: https://vuejs.org/
- **FFmpeg 文档**: https://ffmpeg.org/documentation.html
- **Rust 文档**: https://doc.rust-lang.org/

---

## 许可证

请确保遵守 FFmpeg 的 LGPL/GPL 许可证要求。

---

**最后更新**: 2026-01-31
**版本**: v0.1.13

## 更新日志

### v0.1.13 (2026-01-31)
- ✨ 视频合并随机逻辑优化
  - 实现不放回抽取机制，避免重复选择同一视频
  - 新增 VideoPoolManager 管理视频池状态
  - 池子为空时自动重新填充
  - 支持多目录独立管理
  - 进度提示显示池子剩余数量和重填状态
- ✨ 自动拆解增加掐头去尾功能
  - 新增"掐头"选项：跳过第一个识别的片段
  - 新增"去尾"选项：跳过最后一个识别的片段（默认启用）
  - 添加边界检查和友好错误提示
  - 显示原始片段数和过滤后片段数

### v0.1.12 (2026-01-31)
- 🔧 彻底解决音画不同步问题
  - 视频拼接：使用 filter_complex 统一重编码
  - 每个视频流独立处理：scale + pad + setpts=PTS-STARTPTS
  - 每个音频流独立处理：aresample + asetpts=PTS-STARTPTS
  - 无音频视频自动补齐静音音轨
  - 使用 concat 滤镜拼接，确保时间戳从零开始连续
- 🔧 视频拆解优化
  - 使用 ffprobe 获取精确的帧时间戳
  - 支持多种时间戳字段（best_effort_timestamp_time/pkt_pts_time/pkt_dts_time）
  - 时间戳归一化处理，确保从零开始
  - 使用 setpts=PTS-STARTPTS 重置视频时间戳
  - 使用 asetpts=PTS-STARTPTS 重置音频时间戳
- 🐛 修复 FFmpeg 8.x 兼容性问题

### v0.1.11 (2026-01-30)
- ✨ 新增批量下载功能
  - 支持从多个 URL 并发下载视频文件
  - 实时显示下载进度和速度
  - 可配置最大并发数（默认 3 个）
  - 自动过滤空行和无效 URL
  - 流式下载避免内存占用过大
- 📦 新增依赖：reqwest、tokio、futures-util
- 🎨 新增批量下载 Tab 和组件

### v0.1.9 (2026-01-29)
- ⚡ 自动拆解多线程优化
  - 使用 rayon 并行计算帧相似度
  - 性能提升 5-8 倍（8 核 CPU）
  - CPU 利用率从 12.5% 提升至 80-90%
  - 10 分钟视频处理时间从 10+ 分钟降至 2-3 分钟
- 🔧 优化进度更新频率（从每 50 帧改为每 100 帧）
- 🛡️ 增强错误处理（并行计算中的错误不会中断整体流程）

### v0.1.8 (2026-01-29)
- ✨ 新增自动拆解功能
  - 三种相似度算法：直方图、SSIM、帧差异
  - 可配置相似度阈值和最小片段秒数
  - 无人值守模式：自动保留原视频并处理下一个
  - 批量处理支持
  - 断点续传功能
- 🔧 移除 Windows 便携版打包
- 📝 更新项目文档

### v0.1.4 (2026-01-28)
- 新增交互式视频拆解功能
- 新增批量视频拆解功能
- 优化 UI 布局，采用左侧导航栏设计
- 重构代码为组件化架构
- 优化颜色对比度，提升可读性
- 添加帧选择后自动滚动到顶部功能
- 增强选中帧的视觉反馈（4px 边框）
